
# emotion_detection.py
import requests
import json

def emotion_detector(text_to_analyze):
    """
    Sends text to the Watson Emotion Prediction API and returns emotion scores.
    Handles successful (200) and bad request (400) responses.
    """
    url = 'https://sn-watson-emotion.labs.skills.network/v1/watson.runtime.nlp.v1/NlpService/EmotionPredict'
    
    # Correct headers format
    headers = {
        "grpc-metadata-mm-model-id": "emotion_aggregated_workflow_lang_en_stock"
    }

    # Proper JSON input
    input_json = {
        "raw_document": [
            {
                "text": text_to_analyze
            }
        ]
    }

    try:
        response = requests.post(url, json=input_json, headers=headers)
        status_code = response.status_code

        emotions = {}

        if status_code == 200:
            formatted_response = response.json()
            emotions = formatted_response['emotionPredictions'][0]['emotion']

            # Determine dominant emotion
            dominant_emotion = max(emotions.items(), key=lambda x: x[1])
            emotions['dominant_emotion'] = dominant_emotion[0]

        elif status_code == 400:
            # Return None for all emotions on bad request
            emotions = {
                'anger': None,
                'disgust': None,
                'fear': None,
                'joy': None,
                'sadness': None,
                'dominant_emotion': None
            }

        else:
            # Optional: handle other status codes
            emotions = {
                'anger': None,
                'disgust': None,
                'fear': None,
                'joy': None,
                'sadness': None,
                'dominant_emotion': None
            }

        return emotions

    except requests.exceptions.RequestException as e:
        # Handle connection errors
        return {
            'anger': None,
            'disgust': None,
            'fear': None,
            'joy': None,
            'sadness': None,
            'dominant_emotion': None
        }
